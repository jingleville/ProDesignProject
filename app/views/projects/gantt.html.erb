<% content_for :head do %>
  <%= stylesheet_link_tag "frappe-gantt" %>
<% end %>

<div class="mb-4">
  <%= link_to "&larr; Назад к #{@project.name}".html_safe, project_path(@project), class: "text-indigo-600 hover:text-indigo-800 text-sm" %>
</div>

<h1 class="text-2xl font-bold mb-6">Диаграмма Ганта — <%= @project.name %></h1>

<% tasks_with_dates = @tasks.select { |t| t.start_date.present? && t.due_date.present? } %>

<% if tasks_with_dates.empty? %>
  <p class="text-gray-500">Нет задач с датами для отображения.</p>
<% else %>
  <%
    gantt_tasks = tasks_with_dates.map do |task|
      dep_ids = task.dependencies.select { |d| d.start_date.present? && d.due_date.present? }.map { |d| "task_#{d.id}" }.join(", ")
      {
        id: "task_#{task.id}",
        name: task.title,
        start: task.start_date.strftime("%Y-%m-%d"),
        end: task.due_date.strftime("%Y-%m-%d"),
        progress: task.completed? ? 100 : (task.in_progress? ? 50 : 0),
        dependencies: dep_ids
      }
    end
  %>

  <div class="bg-white shadow rounded-lg p-4 overflow-x-auto"
       data-controller="gantt"
       data-gantt-tasks-value="<%= gantt_tasks.to_json %>">
  </div>
<% end %>
